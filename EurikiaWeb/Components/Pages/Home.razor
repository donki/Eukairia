@page "/home"

@using EukairiaWeb.Data.Models

@rendermode InteractiveServer
@inject ProtectedSessionStorage SessionStorage
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject TimeTrackingService TimeTrackingService
@inject WorkShiftService WorkShiftService;
@inject UsersService UsersService

<MudSnackbarProvider />

<PageTitle>Home</PageTitle>



<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    <MudGrid>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100px;"><MudButton OnClick="TrackTime" Color="Color.Primary">Registrar</MudButton></MudPaper>
        </MudItem>
        <MudItem xs="6" sm="9">
            <MudGrid>
                <MudItem xs="12">
                    <MudPaper Elevation="2" Class="pa-4" Style="max-height: 200px; overflow-y: auto;">
                        <MudTable Items="tracks">
                            <HeaderContent>
                                <MudTh>Inicio</MudTh>
                                <MudTh>Final</MudTh>
                                <MudTh>Minutos dentro del turno</MudTh>
                                <MudTh>Minutos fuera del turno</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                    <MudTd DataLabel="Start Time">@context.StartTime.ToString("HH:mm")</MudTd>
                                    <MudTd DataLabel="End Time">@context.EndTime?.ToString("HH:mm")</MudTd>
                                    <MudTd DataLabel="End Time">@context.MinutesWithinShift</MudTd>
                                    <MudTd DataLabel="End Time">@context.MinutesOutsideShift</MudTd>
                            </RowTemplate>
                        </MudTable>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudItem>
            <MudItem xs="6" sm="3" Class="center-text">
                <MudPaper Elevation="2" Class="pa-4 center-text" Style="text-align:center"><MudText Typo="Typo.h6">Hoy <br /> @Summary?.Daily</MudText></MudPaper>
            </MudItem>
            <MudItem xs="6" sm="3" Class="center-text">
                <MudPaper Elevation="2" Class="pa-4 center-text" Style="text-align:center"><MudText Typo="Typo.h6">Semana Actual<br /> @Summary?.Weekly</MudText></MudPaper>
            </MudItem>
            <MudItem xs="6" sm="3" Class="center-text">
                <MudPaper Elevation="2" Class="pa-4 center-text" Style="text-align:center"><MudText Typo="Typo.h6">Mes Actual<br /> @Summary?.Monthly</MudText></MudPaper>
            </MudItem>
            <MudItem xs="6" sm="3" Class="center-text">
                <MudPaper Elevation="2" Class="pa-4 center-text" Style="text-align:center"><MudText Typo="Typo.h6">Año Actual<br /> @Summary?.Yearly</MudText></MudPaper>
            </MudItem>
     </MudGrid>
</MudContainer>


    @code {

    private Guid UserId = Guid.Empty;
    private List<TimeTracking> tracks = new();
    private TimeTrackingSummary Summary;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var result = await SessionStorage.GetAsync<Guid>("UserId");
        if (!result.Success || (!result.Value.Equals(Guid.Empty)))
        {
            UserId = result.Value;
        }
        tracks = await TimeTrackingService.GetTodaysTracksAsync();
        Summary = await TimeTrackingService.GetTimeTrackingSummary(UserId);

        try
        {
            var result2 = await SessionStorage.GetAsync<bool>("isAuthenticated");
            if (!result2.Success || !result2.Value)
            {
                NavigationManager.NavigateTo("/");

            }
        }
        catch (InvalidOperationException ex)
        {
            Console.WriteLine($"Error al obtener isAuthenticated: {ex.Message}");
            // Considera manejar el error de manera adecuada aquí
        }

        var result3 = await SessionStorage.GetAsync<string>("Name");

        if (result3.Success)
        {

            UsersService.UserName = result3.Value;

        }
        StateHasChanged();
    }

    private async Task TrackTime()
    {
        if (!UserId.Equals(Guid.Empty))
        {
            if(await WorkShiftService.CanRegisterTime(UserId,DateTime.Now))
            {
                await TimeTrackingService.TryTrackTimeAsync(UserId, DateTime.Now, DateTime.Now);
                tracks = await TimeTrackingService.GetTodaysTracksAsync();
                Summary = await TimeTrackingService.GetTimeTrackingSummary(UserId);
                StateHasChanged();

            } else
            {
                Snackbar.Add("El usuario no tiene turnos.", Severity.Error);
            }
        }
    }


}